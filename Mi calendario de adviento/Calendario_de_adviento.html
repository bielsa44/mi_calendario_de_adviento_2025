<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Adviento 2025</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de fuentes de Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Mountains+of+Christmas:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilo personalizado para la fuente del t√≠tulo */
        .font-christmas {
            font-family: 'Mountains of Christmas', cursive;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-red-900 text-white min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor Principal -->
    <div class="w-full max-w-4xl mx-auto">

        <!-- 1. Contenedor del Formulario (Visible al inicio) -->
        <div id="form-container" class="bg-white/10 backdrop-blur-md p-8 sm:p-12 rounded-2xl shadow-xl border border-white/20">
            <h1 class="font-christmas text-5xl sm:text-7xl text-center text-yellow-300 mb-4">¬°Calendario de Adviento!</h1>
            <p class="text-center text-lg text-yellow-100/90 mb-8">Reg√≠strate gratis para desbloquear tus 24 sorpresas diarias.</p>
            
            <form id="login-form">
                <div class="mb-5">
                    <label for="name" class="block text-sm font-medium text-yellow-200 mb-2">Tu Nombre</label>
                    <input type="text" id="name" name="name" placeholder="Ej: Pap√° Noel" required 
                           class="w-full p-3 rounded-lg bg-white/90 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-yellow-400/50 transition duration-300">
                </div>
                <div class="mb-8">
                    <label for="email" class="block text-sm font-medium text-yellow-200 mb-2">Tu Correo Electr√≥nico</label>
                    <input type="email" id="email" name="email" placeholder="ej: santa@polo.norte" required 
                           class="w-full p-3 rounded-lg bg-white/90 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-4 focus:ring-yellow-400/50 transition duration-300">
                </div>
                <button type="submit" 
                        class="w-full bg-yellow-400 text-red-900 font-bold text-lg p-4 rounded-lg shadow-lg transform transition duration-300 hover:bg-yellow-300 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-400/50">
                    Acceder a las Sorpresas üéÅ
                </button>
            </form>
            <p class="text-center text-xs text-yellow-100/70 mt-6">Valoramos tu privacidad. No compartiremos tus datos.</p>
        </div>

        <!-- 2. Contenedor del Calendario (Oculto al inicio) -->
        <div id="calendar-container" class="hidden">
            <h1 class="font-christmas text-6xl sm:text-8xl text-center text-yellow-300 mb-2">¬°Feliz Adviento, <span id="user-name" class="text-white"></span>!</h1>
            <p class="text-center text-lg text-yellow-100/90 mb-8">Haz clic en el d√≠a de hoy para ver tu sorpresa.</p>
            
            <!-- Rejilla del Calendario -->
            <div id="calendar-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 p-4 bg-white/10 backdrop-blur-md rounded-2xl shadow-inner border border-white/20">
                <!-- Las puertas se generan con JavaScript -->
            </div>
        </div>

    </div>

    <!-- 3. Contenedor del Modal (Oculto por defecto) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white text-gray-900 p-8 rounded-2xl shadow-xl w-full max-w-md transform transition-all scale-95 opacity-0" id="modal-box">
            <h2 class="font-christmas text-5xl text-red-800 mb-4" id="modal-day"></h2>
            <img id="modal-image" src="" alt="Sorpresa" class="w-full h-48 object-cover rounded-lg mb-4">
            <p class="text-lg mb-6" id="modal-content"></p>

            <!-- ‚ú® Contenedor de Gemini (NUEVO) -->
            <div class="mt-6 space-y-4">
                <!-- Bot√≥n de Gemini -->
                <button id="gemini-button" class="w-full bg-blue-600 text-white font-bold p-3 rounded-lg shadow-lg transform transition duration-300 hover:bg-blue-500 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-600/50">
                    <!-- El texto se pondr√° desde JS -->
                </button>
                
                <!-- Indicador de Carga -->
                <div id="gemini-loading" class="hidden text-center py-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-800 mx-auto"></div>
                    <p class="mt-2 text-sm text-gray-600">Generando sorpresa...</p>
                </div>

                <!-- Contenedor de Resultado -->
                <div id="gemini-result-container" class="hidden bg-gray-100 p-4 rounded-lg text-gray-800 text-sm max-h-40 overflow-y-auto border border-gray-300">
                    <!-- El resultado se pondr√° desde JS -->
                </div>
            </div>

            <!-- Bot√≥n de Cerrar (Existente) -->
            <button id="close-modal-button" 
                    class="mt-6 w-full bg-red-800 text-white font-bold p-3 rounded-lg shadow-lg transform transition duration-300 hover:bg-red-700 hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-800/50">
                Cerrar
            </button>
        </div>
    </div>

    <script>
        // --- Referencias a elementos del DOM ---
        const formContainer = document.getElementById('form-container');
        const calendarContainer = document.getElementById('calendar-container');
        const loginForm = document.getElementById('login-form');
        const userNameSpan = document.getElementById('user-name');
        const calendarGrid = document.getElementById('calendar-grid');
        
        const modalContainer = document.getElementById('modal-container');
        const modalBox = document.getElementById('modal-box');
        const modalDay = document.getElementById('modal-day');
        const modalImage = document.getElementById('modal-image');
        const modalContent = document.getElementById('modal-content');
        const closeModalButton = document.getElementById('close-modal-button');

        // --- Nuevas referencias de Gemini ---
        const geminiButton = document.getElementById('gemini-button');
        const geminiLoading = document.getElementById('gemini-loading');
        const geminiResultContainer = document.getElementById('gemini-result-container');

        // --- Configuraci√≥n de la API de Gemini ---
        // DEJA LA API KEY VAC√çA. Se gestionar√° autom√°ticamente.
        const apiKey = ""; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const systemPrompt = "Act√∫a como un elfo del calendario de adviento. Eres juguet√≥n, amigable y te encanta interactuar. Tu objetivo no es solo *dar* informaci√≥n, sino *jugar* con el usuario. Haz preguntas, crea peque√±os juegos (como trivias o 'completa la frase') y s√© muy alegre. Tus respuestas deben ser concisas y para toda la familia.";

        // --- Lista de Sorpresas (ACTUALIZADA con prompts interactivos) ---
        const surprises = [
            { text: "Un chocolate caliente virtual. ‚òï ¬°Disfr√∫talo!", img: "https://placehold.co/600x400/D2691E/FFFFFF?text=Chocolate+Caliente", geminiButtonText: "‚ú® ¬øC√≥mo lo prefieres?", geminiPrompt: "Hazme una pregunta sobre mi chocolate caliente ideal (ej: '¬øTe gusta con canela o con nata?') y luego dame una receta basada en esa idea." },
            { text: "Canta tu villancico favorito... ¬°en voz alta! üé∂", img: "https://placehold.co/600x400/FFD700/000000?text=Nota+Musical", geminiButtonText: "‚ú® Completa la letra", geminiPrompt: "Escribe la primera estrofa de un villancico navide√±o popular, pero deja dos palabras clave en blanco (ej: 'Noche de ____, noche de ____') y p√≠deme que las adivine." },
            { text: "Hoy es un buen d√≠a para ver 'Mi Pobre Angelito'. üè†", img: "https://placehold.co/600x400/00008B/FFFFFF?text=Casa+con+Trampas", geminiButtonText: "‚ú® ¬°Trivia de pel√≠cula!", geminiPrompt: "Dame una pregunta de trivia sobre la pel√≠cula 'Mi Pobre Angelito' (Home Alone) y dame 3 opciones (A, B, C). Al final, revela la respuesta correcta." },
            { text: "Escribe 3 cosas por las que est√©s agradecido hoy. üôè", img: "https://placehold.co/600x400/8A2BE2/FFFFFF?text=Gracias", geminiButtonText: "‚ú® Juguemos a 'Veo, Veo... Agradecido'", geminiPrompt: "Inicia un juego. Di 'Veo, veo... algo por lo que estar agradecido que sea...' y da una pista (ej: '...algo caliente que bebes'). P√≠deme que adivine." },
            { text: "¬°Foto divertida! Hazte un selfie con un filtro navide√±o. üéÖ", img: "https://placehold.co/600x400/FF69B4/FFFFFF?text=Selfie+Time", geminiButtonText: "‚ú® ¬øQu√© filtro elijo?", geminiPrompt: "Prop√≥n un divertido 'Este o Aquel' para un selfie navide√±o. (Ej: '¬øPrefieres un filtro con cuernos de reno o con gorro de Pap√° Noel?')." },
            { text: "Llama a un amigo o familiar solo para saludar.", img: "https://placehold.co/600x400/4682B4/FFFFFF?text=Hola", geminiButtonText: "‚ú® ¬øDe qu√© hablamos?", geminiPrompt: "Dame 3 ideas divertidas para romper el hielo o temas de conversaci√≥n alegres para iniciar una llamada con un amigo." },
            { text: "Un bast√≥n de caramelo virtual. ¬°Dulce! üç¨", img: "https://placehold.co/600x400/FF0000/FFFFFF?text=Caramelo", geminiButtonText: "‚ú® ¬øVerdadero o Falso?", geminiPrompt: "Dame un dato curioso sobre el bast√≥n de caramelo y p√≠deme que adivine si es 'Verdadero o Falso'. Luego, revela la respuesta." },
            { text: "T√≥mate 5 minutos para estirarte y respirar.", img: "https://placehold.co/600x400/008080/FFFFFF?text=Relax", geminiButtonText: "‚ú® Gu√≠a mi respiraci√≥n", geminiPrompt: "Gu√≠ame con 3 instrucciones de respiraci√≥n sencillas (ej: '1. Inspira contando hasta 4...')." },
            { text: "Dibuja un reno. No importa c√≥mo salga. ü¶å", img: "https://placehold.co/600x400/8B4513/FFFFFF?text=Reno", geminiButtonText: "‚ú® ¬øC√≥mo lo llamamos?", geminiPrompt: "¬°Ay√∫dame a ponerle nombre a mi reno dibujado! Dame 3 sugerencias de nombres divertidos para un reno." },
            { text: "Busca una receta de galletas de jengibre. üç™", img: "https://placehold.co/600x400/D2691E/FFFFFF?text=Galleta", geminiButtonText: "‚ú® ¬øQu√© ingrediente falta?", geminiPrompt: "Dame una lista de 4 ingredientes para galletas de jengibre, pero olvida uno que sea obvio (ej: jengibre). P√≠deme que adivine el ingrediente secreto." },
            { text: "Un copo de nieve √∫nico, ¬°como t√∫! ‚ùÑÔ∏è", img: "https://placehold.co/600x400/ADD8E6/000000?text=Copo+de+Nieve", geminiButtonText: "‚ú® Trivia de nieve", geminiPrompt: "Dame una pregunta de trivia sobre la nieve (con opciones A, B, C) y luego revela la respuesta." },
            { text: "Dona un juguete o ropa que ya no necesites.", img: "https://placehold.co/600x400/32CD32/FFFFFF?text=Donar", geminiButtonText: "‚ú® Insp√≠rame a donar", geminiPrompt: "Escribe una frase corta (1-2 l√≠neas) sobre c√≥mo un peque√±o gesto de donaci√≥n puede hacer una gran diferencia." },
            { text: "Ponte calcetines divertidos hoy.", img: "https://placehold.co/600x400/FFC0CB/000000?text=Calcetines", geminiButtonText: "‚ú® Completa el poema", geminiPrompt: "Escribe un poema de 4 l√≠neas sobre calcetines navide√±os, pero deja la √∫ltima palabra en blanco para que yo la complete." },
            { text: "Escucha 'All I Want for Christmas Is You'. üé§", img: "https://placehold.co/600x400/FFD700/000000?text=Hit+Navide√±o", geminiButtonText: "‚ú® Adivina la canci√≥n", geminiPrompt: "Dame 3-4 palabras clave de la letra de un villancico famoso (que no sea el de Mariah Carey) y p√≠deme que adivine la canci√≥n." },
            { text: "Un abrazo virtual gigante para ti. ü§ó", img: "https://placehold.co/600x400/FF69B4/FFFFFF?text=Abrazo", geminiButtonText: "‚ú® ¬øAbrazo de oso o de elfo?", geminiPrompt: "Preg√∫ntame qu√© tipo de abrazo virtual prefiero hoy: '¬øUn abrazo de oso gigante o un abrazo r√°pido de elfo juguet√≥n?'." },
            { text: "Aprende a decir 'Feliz Navidad' en otro idioma.", img: "https://placehold.co/600x400/00008B/FFFFFF?text=Hola+Mundo", geminiButtonText: "‚ú® Ens√©√±ame un idioma", geminiPrompt: "Elige un idioma (ej: japon√©s, italiano, alem√°n) y ens√©√±ame a decir 'Feliz Navidad' y c√≥mo pronunciarlo de forma simple." },
            { text: "Decora tu espacio de trabajo con algo festivo.", img: "https://placehold.co/600x400/FF0000/FFFFFF?text=Espumill√≥n", geminiButtonText: "‚ú® ¬øQu√© elijo?", geminiPrompt: "Prop√≥n una encuesta r√°pida: '¬øQu√© decoraci√≥n DIY prefieres para tu escritorio: un mini-√°rbol de papel o una guirnalda de clips?'" },
            { text: "¬°Una mandarina! (Virtual, claro). üçä", img: "https://placehold.co/600x400/FFA500/FFFFFF?text=Vitamina+C", geminiButtonText: "‚ú® Trivia de frutas", geminiPrompt: "Dame un dato curioso sobre las mandarinas (o clementinas) y p√≠deme que adivine si es 'Verdadero o Falso'." },
            { text: "Piensa en tu mejor recuerdo navide√±o.", img: "https://placehold.co/600x400/8A2BE2/FFFFFF?text=Recuerdo", geminiButtonText: "‚ú® ¬øOlor o Sabor?", geminiPrompt: "Hazme una pregunta para ayudarme a recordar: '¬øQu√© olor o sabor te recuerda instant√°neamente a la Navidad?'." },
            { text: "Enciende una vela con olor a canela o pino.", img: "https://placehold.co/600x400/D2691E/FFFFFF?text=Vela", geminiButtonText: "‚ú® Adivina el olor", geminiPrompt: "Describe un olor navide√±o (ej: 'Soy dulce, especiado y me ponen en el vino caliente') y p√≠deme que adivine qu√© es." },
            { text: "¬°Has encontrado un elfo escondido! üßù", img: "https://placehold.co/600x400/32CD32/FFFFFF?text=Elfo", geminiButtonText: "‚ú® ¬øD√≥nde se escondi√≥?", geminiPrompt: "Juguemos al escondite. Dame 3 pistas sobre d√≥nde se ha escondido un elfo travieso en una cocina." },
            { text: "Prepara la lista de regalos... ¬°o simplemente rel√°jate!", img: "https://placehold.co/600x400/4682B4/FFFFFF?text=Lista", geminiButtonText: "‚ú® ¬øRegalo hecho o comprado?", geminiPrompt: "Plantea un dilema divertido: 'Si tuvieras que elegir, ¬øpreferir√≠as recibir un regalo hecho a mano con mucho cari√±o o el regalo perfecto de una tienda?'" },
            { text: "¬°Casi Navidad! Mira las luces de la calle.", img: "https://placehold.co/600x400/FFD700/000000?text=Luces", geminiButtonText: "‚ú® ¬øQu√© ves en las luces?", geminiPrompt: "Preg√∫ntame qu√© formas veo en las luces de Navidad, como si fueran nubes (ej: '¬øVes un reno, una estrella o un bast√≥n de caramelo?')." },
            { text: "¬°FELIZ NOCHEBUENA! üéÑ La magia est√° en compartir.", img: "https://placehold.co/600x400/FF0000/FFFFFF?text=Feliz+Navidad", geminiButtonText: "‚ú® Mi deseo de Nochebuena", geminiPrompt: "P√≠deme que piense en un deseo de Nochebuena para alguien m√°s. Luego, genera t√∫ un deseo corto y universal para todos." }
        ];

        // --- L√≥gica de la Aplicaci√≥n ---

        // 1. Manejar el env√≠o del formulario
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Evitar que la p√°gina se recargue
            
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');

            // Validaci√≥n simple (HTML 'required' ya hace la mayor parte)
            if (nameInput.value.trim() !== '' && emailInput.value.trim() !== '') {
                // Mostrar el nombre del usuario
                userNameSpan.textContent = nameInput.value.trim();
                
                // Ocultar formulario y mostrar calendario con animaci√≥n
                formContainer.classList.add('opacity-0', 'scale-95');
                formContainer.classList.add('transition-all', 'duration-500');

                setTimeout(() => {
                    formContainer.classList.add('hidden');
                    calendarContainer.classList.remove('hidden');
                    calendarContainer.classList.add('opacity-0', 'scale-95');
                    
                    // Peque√±o retardo para que la transici√≥n de entrada sea visible
                    setTimeout(() => {
                        calendarContainer.classList.remove('opacity-0', 'scale-95');
                        calendarContainer.classList.add('transition-all', 'duration-500', 'opacity-100', 'scale-100');
                    }, 50);

                }, 500);
            }
        });

        // 2. Generar las puertas del calendario
        function createCalendar() {
            const today = new Date();
            // Para pruebas: cambiar 'today.getDate()' por un n√∫mero, ej. 25, para abrirlos todos.
            // O poner 0 para deshabilitar la restricci√≥n.
            const currentDay = today.getMonth() === 11 ? today.getDate() : 0; // Solo activo en Diciembre
            const openedDays = JSON.parse(localStorage.getItem('openedDays') || '[]');

            for (let i = 1; i <= 24; i++) {
                const day = i;
                const surprise = surprises[day - 1];
                
                const door = document.createElement('div');
                door.textContent = day;
                door.dataset.day = day;
                
                let isOpened = openedDays.includes(day);
                let canBeOpened = day <= currentDay || currentDay === 0; // Permite abrir si es d√≠a pasado o si estamos probando (0)

                // Clases base
                let doorClasses = "aspect-square flex items-center justify-center font-christmas text-5xl rounded-lg shadow-lg transform transition duration-300";

                if (isOpened) {
                    // D√≠a ya abierto
                    doorClasses += " bg-yellow-200/50 text-red-900/60 cursor-pointer hover:scale-105";
                } else if (canBeOpened) {
                    // D√≠a que se puede abrir hoy
                    doorClasses += " bg-green-700 text-white cursor-pointer hover:bg-green-600 hover:scale-110 hover:shadow-2xl animate-pulse";
                } else {
                    // D√≠a futuro
                    doorClasses += " bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-70";
                }
                
                door.className = doorClasses;

                // A√±adir evento de clic solo si se puede abrir (o ya se abri√≥)
                if (canBeOpened || isOpened) {
                    door.addEventListener('click', () => {
                        showModal(day, surprise, door);
                        
                        // Marcar como abierto
                        if (!isOpened) {
                            isOpened = true;
                            openedDays.push(day);
                            localStorage.setItem('openedDays', JSON.stringify(openedDays));
                            
                            // Actualizar estilo
                            door.className = "aspect-square flex items-center justify-center font-christmas text-5xl rounded-lg shadow-lg transform transition duration-300 bg-yellow-200/50 text-red-900/60 cursor-pointer hover:scale-105";
                            door.classList.remove('animate-pulse');
                        }
                    });
                }

                calendarGrid.appendChild(door);
            }
        }
        
        // --- Nuevas funciones de la API Gemini ---
        
        /**
         * Maneja las solicitudes fetch con reintentos y backoff exponencial.
         */
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response;
                    }
                    // No reintentar en errores de cliente (4xx)
                    if (response.status >= 400 && response.status < 500) {
                        console.error("Error de cliente, no reintentando:", response.status);
                        return response; // Devolver la respuesta de error
                    }
                    // Reintentar en errores de servidor (5xx)
                    console.warn(`Error de servidor (${response.status}), reintentando... (${i + 1}/${retries})`);
                } catch (error) {
                    console.warn(`Error de red, reintentando... (${i + 1}/${retries}):`, error.message);
                }
                // Esperar antes de reintentar
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2; // Backoff exponencial
            }
            // Si todos los reintentos fallan, lanzar un error
            throw new Error("No se pudo conectar a la API despu√©s de varios intentos.");
        }

        /**
         * Llama a la API de Gemini con un prompt.
         */
        async function callGeminiApi(prompt) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                ]
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithBackoff(GEMINI_API_URL, options);
                
                if (!response.ok) {
                    console.error("La solicitud a la API fall√≥ con estado:", response.status);
                    const errorBody = await response.json();
                    console.error("Detalles del error:", errorBody);
                    return "Hubo un error al contactar la IA. Intenta de nuevo.";
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.warn("Respuesta inesperada de la API:", result);
                    if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                        return "La respuesta fue bloqueada por razones de seguridad. Intenta con un texto diferente.";
                    }
                    return "No se pudo generar una respuesta.";
                }
            } catch (error) {
                console.error("Error en callGeminiApi:", error);
                return "Error de conexi√≥n. Revisa tu conexi√≥n a internet.";
            }
        }


        // 3. Mostrar el modal (ACTUALIZADO)
        function showModal(day, surprise, doorElement) {
            modalDay.textContent = `D√≠a ${day}`;
            modalContent.textContent = surprise.text;
            modalImage.src = surprise.img;

            // --- L√≥gica de Gemini ---
            // 1. Resetear estado
            geminiLoading.classList.add('hidden');
            geminiResultContainer.classList.add('hidden');
            geminiResultContainer.innerHTML = '';
            geminiButton.classList.remove('hidden');

            // 2. Configurar bot√≥n
            geminiButton.textContent = surprise.geminiButtonText;
            
            // 3. Asignar evento de clic
            // Usamos .onclick para reemplazar f√°cilmente el listener anterior
            geminiButton.onclick = async () => {
                geminiButton.classList.add('hidden');
                geminiLoading.classList.remove('hidden');

                const prompt = surprise.geminiPrompt;
                const result = await callGeminiApi(prompt);
                
                // Formatear resultado (reemplazar saltos de l√≠nea por <br>)
                const formattedResult = result.replace(/\n/g, '<br>');

                geminiLoading.classList.add('hidden');
                geminiResultContainer.innerHTML = formattedResult;
                geminiResultContainer.classList.remove('hidden');
            };
            // --- Fin L√≥gica Gemini ---
            
            modalContainer.classList.remove('hidden');
            
            // Animaci√≥n de entrada del modal
            setTimeout(() => {
                modalBox.classList.remove('scale-95', 'opacity-0');
                modalBox.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        // 4. Ocultar el modal
        function hideModal() {
            modalBox.classList.remove('scale-100', 'opacity-100');
            modalBox.classList.add('scale-95', 'opacity-0');

            // Resetear estado de Gemini al cerrar
            geminiButton.classList.remove('hidden');
            geminiLoading.classList.add('hidden');
            geminiResultContainer.classList.add('hidden');
            geminiResultContainer.innerHTML = '';

            setTimeout(() => {
                modalContainer.classList.add('hidden');
            }, 300); // Esperar a que termine la animaci√≥n
        }

        closeModalButton.addEventListener('click', hideModal);
        // Opcional: cerrar al hacer clic fuera del modal
        modalContainer.addEventListener('click', function(e) {
            if (e.target === modalContainer) {
                hideModal();
            }
        });

        // --- Inicializaci√≥n ---
        createCalendar();

    </script>
</body>
</html>